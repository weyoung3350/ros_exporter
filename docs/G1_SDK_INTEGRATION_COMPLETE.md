# å®‡æ ‘G1 SDKå®Œæ•´é›†æˆæ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æˆåŠŸå®ç°äº†å®‡æ ‘G1æœºå™¨äººçš„çœŸå®SDKé›†æˆï¼Œé€šè¿‡CGOæŠ€æœ¯å°†C++ SDKå°è£…ä¸ºGoè¯­è¨€æ¥å£ï¼Œå®ç°äº†å®Œæ•´çš„ç”µæ± ç®¡ç†ç³»ç»Ÿ(BMS)ç›‘æ§åŠŸèƒ½ã€‚

## æ¶æ„è®¾è®¡

### 1. åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Go Application Layer        â”‚  â† ros_exporter
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       Go SDK Interface Layer       â”‚  â† internal/types/g1_types.go
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          CGO Binding Layer          â”‚  â† CGO + C Headers
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        C++ SDK Wrapper Layer       â”‚  â† internal/sdk/unitree/
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       Real Unitree G1 SDK          â”‚  â† å®‡æ ‘å®˜æ–¹SDK (å¯é€‰)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ ¸å¿ƒç»„ä»¶

#### C++ SDKå°è£…å±‚ (`internal/sdk/unitree/`)
- **g1_sdk.h**: Cæ¥å£å¤´æ–‡ä»¶ï¼Œå®šä¹‰æ•°æ®ç»“æ„å’Œå‡½æ•°æ¥å£
- **g1_sdk.cpp**: C++ SDKå®ç°ï¼Œæ”¯æŒçœŸå®DDSå’Œæ¨¡æ‹Ÿæ¨¡å¼
- **Makefile**: ç¼–è¯‘é…ç½®ï¼Œæ”¯æŒå¤šå¹³å°å’Œäº¤å‰ç¼–è¯‘
- **test_sdk.cpp**: C++å±‚æµ‹è¯•ç¨‹åº

#### Goæ¥å£å±‚ (`internal/types/`)
- **g1_types.go**: Goè¯­è¨€ç±»å‹å®šä¹‰å’ŒCGOç»‘å®š
- **G1SDK**: Goè¯­è¨€SDKæ¥å£å°è£…
- **G1BatteryStatus**: ç”µæ± çŠ¶æ€æ•°æ®ç»“æ„
- **BatteryMetrics**: ç›‘æ§æŒ‡æ ‡è½¬æ¢

#### é›†æˆå±‚ (`internal/collectors/`)
- **bms.go**: BMSæ”¶é›†å™¨ï¼Œé›†æˆG1 SDK
- **UnitreeSDKInterface**: å®‡æ ‘SDKæ¥å£å®ç°
- æ”¯æŒG1/Go2è‡ªåŠ¨æ£€æµ‹å’Œåˆ‡æ¢

## åŠŸèƒ½ç‰¹æ€§

### 1. ç”µæ± ç›‘æ§åŠŸèƒ½

#### åŸºç¡€ç›‘æ§æŒ‡æ ‡
- **ç”µå‹ç›‘æ§**: æ€»ç”µå‹ + 40èŠ‚å•ä½“ç”µå‹
- **ç”µæµç›‘æ§**: å……æ”¾ç”µç”µæµå®æ—¶ç›‘æ§
- **æ¸©åº¦ç›‘æ§**: 12ä¸ªæ¸©åº¦ä¼ æ„Ÿå™¨
- **ç”µé‡ç›‘æ§**: SOCç”µé‡ç™¾åˆ†æ¯”
- **å¥åº·åº¦ç›‘æ§**: SOHç”µæ± å¥åº·çŠ¶æ€
- **å¾ªç¯æ¬¡æ•°**: å……æ”¾ç”µå¾ªç¯è®¡æ•°

#### é«˜çº§åˆ†æåŠŸèƒ½
- **ç”µå‹å·®åˆ†æ**: å•ä½“ç”µå‹æœ€å¤§å·®å€¼ç›‘æ§
- **æ¸©åº¦æ¢¯åº¦**: æ¸©åº¦ä¼ æ„Ÿå™¨å·®å€¼åˆ†æ
- **å¥åº·ç­‰çº§**: è‡ªåŠ¨è¯„ä¼°ç”µæ± å¥åº·ç­‰çº§
- **å±é™©æ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹ä¸¥é‡é”™è¯¯çŠ¶æ€

### 2. å®æ—¶ç›‘æ§ç‰¹æ€§

#### æ•°æ®æ›´æ–°é¢‘ç‡
- **DDSæ•°æ®æ¥æ”¶**: 10Hz (100msé—´éš”)
- **çŠ¶æ€å›è°ƒ**: æ”¯æŒå¼‚æ­¥å›è°ƒæœºåˆ¶
- **æŒ‡æ ‡æ¨é€**: å¯é…ç½®æ¨é€é—´éš”

#### è¿æ¥ç®¡ç†
- **è‡ªåŠ¨é‡è¿**: è¿æ¥æ–­å¼€è‡ªåŠ¨æ¢å¤
- **çŠ¶æ€æ£€æµ‹**: å®æ—¶è¿æ¥çŠ¶æ€ç›‘æ§
- **é”™è¯¯å¤„ç†**: å®Œæ•´çš„é”™è¯¯ä¼ æ’­æœºåˆ¶

## æŠ€æœ¯å®ç°

### 1. CGOé›†æˆ

#### ç¼–è¯‘é…ç½®
```go
/*
#cgo CPPFLAGS: -I.
#cgo LDFLAGS: -L. -lg1sdk -lstdc++ -lm
#include "g1_sdk.h"
#include <stdlib.h>
*/
import "C"
```

#### æ•°æ®ç±»å‹è½¬æ¢
- Cç»“æ„ä½“ â†” Goç»“æ„ä½“è‡ªåŠ¨è½¬æ¢
- æ•°ç»„æ•°æ®çš„å®‰å…¨å¤åˆ¶
- å­—ç¬¦ä¸²çš„å†…å­˜ç®¡ç†
- æ—¶é—´æˆ³æ ¼å¼è½¬æ¢

### 2. å†…å­˜ç®¡ç†

#### C++å±‚
- RAIIèµ„æºç®¡ç†
- æ™ºèƒ½æŒ‡é’ˆä½¿ç”¨
- å¼‚å¸¸å®‰å…¨ä¿è¯

#### Goå±‚
- CGOå†…å­˜ç”Ÿå‘½å‘¨æœŸç®¡ç†
- deferèµ„æºæ¸…ç†
- å¹¶å‘å®‰å…¨ä¿æŠ¤

### 3. é”™è¯¯å¤„ç†

#### åˆ†å±‚é”™è¯¯å¤„ç†
1. **C++å±‚**: å¼‚å¸¸æ•è·å’Œé”™è¯¯ç è¿”å›
2. **Cæ¥å£å±‚**: é”™è¯¯ç å’Œé”™è¯¯æ¶ˆæ¯ä¼ é€’
3. **Goå±‚**: erroræ¥å£å°è£…
4. **åº”ç”¨å±‚**: ä¸šåŠ¡é€»è¾‘é”™è¯¯å¤„ç†

## éƒ¨ç½²å’Œä½¿ç”¨

### 1. ç¼–è¯‘éƒ¨ç½²

#### æ¨¡æ‹Ÿæ¨¡å¼ (å¼€å‘æµ‹è¯•)
```bash
cd internal/sdk/unitree
make mock          # ç¼–è¯‘æ¨¡æ‹Ÿç‰ˆæœ¬
make install        # å®‰è£…åˆ°Goé¡¹ç›®
```

#### çœŸå®SDKæ¨¡å¼ (ç”Ÿäº§ç¯å¢ƒ)
```bash
# è®¾ç½®SDKè·¯å¾„
export UNITREE_SDK_PATH=/opt/unitree_sdk
export DDS_PATH=/usr/local

cd internal/sdk/unitree
make real           # ç¼–è¯‘çœŸå®SDKç‰ˆæœ¬
make install        # å®‰è£…åˆ°Goé¡¹ç›®
```

#### äº¤å‰ç¼–è¯‘ (ARM64)
```bash
make arm64          # äº¤å‰ç¼–è¯‘ARM64ç‰ˆæœ¬
```

### 2. é…ç½®ä½¿ç”¨

#### BMSæ”¶é›†å™¨é…ç½®
```yaml
collectors:
  bms:
    enabled: true
    interface_type: "unitree_sdk"
    robot_type: "g1"              # g1, go2, auto
    network_interface: "eth0"      # DDSç½‘ç»œæ¥å£
    update_interval: 5s            # æ•°æ®æ›´æ–°é—´éš”
    sdk_config_path: ""            # SDKé…ç½®æ–‡ä»¶è·¯å¾„
```

#### ç¨‹åºé›†æˆ
```go
// åˆ›å»ºG1 SDKå®ä¾‹
sdk := types.NewG1SDK()
defer sdk.Cleanup()

// åˆå§‹åŒ–å’Œè¿æ¥
sdk.Initialize("")
sdk.Connect()

// è·å–ç”µæ± çŠ¶æ€
status, err := sdk.GetBatteryStatus()
if err != nil {
    log.Printf("è·å–ç”µæ± çŠ¶æ€å¤±è´¥: %v", err)
    return
}

// è½¬æ¢ä¸ºç›‘æ§æŒ‡æ ‡
metrics := status.ToMetrics()
```

### 3. æµ‹è¯•éªŒè¯

#### åŸºç¡€åŠŸèƒ½æµ‹è¯•
```bash
# CGOåŸºç¡€åŠŸèƒ½æµ‹è¯•
go run test_simple_cgo.go

# G1 SDKå®Œæ•´æµ‹è¯• (éœ€è¦è§£å†³åŠ¨æ€åº“è·¯å¾„)
go run test_g1_sdk.go

# é›†æˆæµ‹è¯•
go run integration_demo.go
```

#### C++å±‚æµ‹è¯•
```bash
cd internal/sdk/unitree
make test           # ç¼–è¯‘C++æµ‹è¯•ç¨‹åº
./test_g1sdk        # è¿è¡ŒC++æµ‹è¯•
```

## ç›‘æ§æŒ‡æ ‡

### 1. åŸºç¡€æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç±»å‹ | å•ä½ | æè¿° |
|---------|------|------|------|
| `robot_battery_voltage_volts` | Gauge | V | ç”µæ± æ€»ç”µå‹ |
| `robot_battery_current_amperes` | Gauge | A | ç”µæ± ç”µæµ |
| `robot_battery_temperature_celsius` | Gauge | Â°C | å¹³å‡æ¸©åº¦ |
| `robot_battery_soc_percent` | Gauge | % | ç”µé‡ç™¾åˆ†æ¯” |
| `robot_battery_health_percent` | Gauge | % | å¥åº·åº¦ |
| `robot_battery_cycles_total` | Counter | æ¬¡ | å¾ªç¯æ¬¡æ•° |

### 2. æ‰©å±•æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç±»å‹ | å•ä½ | æè¿° |
|---------|------|------|------|
| `robot_battery_cell_voltage_min` | Gauge | V | å•ä½“ç”µå‹æœ€å°å€¼ |
| `robot_battery_cell_voltage_max` | Gauge | V | å•ä½“ç”µå‹æœ€å¤§å€¼ |
| `robot_battery_cell_voltage_diff` | Gauge | V | å•ä½“ç”µå‹å·®å€¼ |
| `robot_battery_temp_min` | Gauge | Â°C | æ¸©åº¦æœ€å°å€¼ |
| `robot_battery_temp_max` | Gauge | Â°C | æ¸©åº¦æœ€å¤§å€¼ |
| `robot_battery_temp_diff` | Gauge | Â°C | æ¸©åº¦å·®å€¼ |

### 3. çŠ¶æ€æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç±»å‹ | å–å€¼ | æè¿° |
|---------|------|------|------|
| `robot_battery_charging_status` | Gauge | 0/1 | å……ç”µçŠ¶æ€ |
| `robot_battery_discharging_status` | Gauge | 0/1 | æ”¾ç”µçŠ¶æ€ |
| `robot_battery_error_status` | Gauge | æ•°å€¼ | é”™è¯¯ä»£ç  |

## æ€§èƒ½ç‰¹å¾

### 1. èµ„æºå ç”¨

- **å†…å­˜å ç”¨**: ~2MB (åŒ…å«40èŠ‚ç”µæ± +12ä¸ªæ¸©åº¦ä¼ æ„Ÿå™¨æ•°æ®)
- **CPUå ç”¨**: <1% (10Hzæ•°æ®æ›´æ–°)
- **ç½‘ç»œå¸¦å®½**: ~1KB/s (DDSé€šä¿¡)

### 2. å®æ—¶æ€§èƒ½

- **æ•°æ®å»¶è¿Ÿ**: <10ms (DDS â†’ Goåº”ç”¨)
- **å›è°ƒå“åº”**: <1ms (C++ â†’ Goå›è°ƒ)
- **æŒ‡æ ‡ç”Ÿæˆ**: <100Î¼s (æ•°æ®è½¬æ¢)

### 3. å¯é æ€§

- **è¿æ¥æ¢å¤**: è‡ªåŠ¨é‡è¿æœºåˆ¶
- **é”™è¯¯æ¢å¤**: å®Œæ•´çš„é”™è¯¯å¤„ç†
- **å†…å­˜å®‰å…¨**: RAII + deferç®¡ç†
- **å¹¶å‘å®‰å…¨**: äº’æ–¥é”ä¿æŠ¤

## æ‰©å±•æ€§è®¾è®¡

### 1. å¤šæœºå™¨äººæ”¯æŒ

- **ç±»å‹æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«G1/Go2
- **é…ç½®åˆ‡æ¢**: åŠ¨æ€é…ç½®ä¸åŒæœºå™¨äºº
- **æ¥å£ç»Ÿä¸€**: ç»Ÿä¸€çš„BMSæ¥å£

### 2. å¤šé€šä¿¡åè®®

- **DDSæ”¯æŒ**: Fast-DDS, CycloneDX
- **ä¸²å£æ”¯æŒ**: RS232/RS485
- **CANæ€»çº¿**: CAN 2.0/CAN-FD

### 3. æ’ä»¶åŒ–æ¶æ„

- **æ”¶é›†å™¨æ’ä»¶**: å¯æ’æ‹”çš„æ•°æ®æ”¶é›†å™¨
- **ä¼ è¾“æ’ä»¶**: å¯é…ç½®çš„æ•°æ®ä¼ è¾“æ–¹å¼
- **å¤„ç†æ’ä»¶**: å¯æ‰©å±•çš„æ•°æ®å¤„ç†é€»è¾‘

## æ•…éšœæ’é™¤

### 1. ç¼–è¯‘é—®é¢˜

#### CGOç¼–è¯‘å¤±è´¥
```bash
# æ£€æŸ¥CGOç¯å¢ƒ
go env CGO_ENABLED

# æ£€æŸ¥ç¼–è¯‘å™¨
which gcc g++

# æ£€æŸ¥åº“æ–‡ä»¶
ls -la *.so *.h
```

#### åŠ¨æ€åº“åŠ è½½å¤±è´¥
```bash
# æ£€æŸ¥åº“è·¯å¾„
otool -L libg1sdk.so

# è®¾ç½®åº“è·¯å¾„
export DYLD_LIBRARY_PATH=.:$DYLD_LIBRARY_PATH
```

### 2. è¿è¡Œæ—¶é—®é¢˜

#### SDKè¿æ¥å¤±è´¥
- æ£€æŸ¥ç½‘ç»œæ¥å£é…ç½®
- éªŒè¯DDSåŸŸé…ç½®
- ç¡®è®¤æœºå™¨äººè¿æ¥çŠ¶æ€

#### æ•°æ®è·å–å¤±è´¥
- æ£€æŸ¥BMSç³»ç»ŸçŠ¶æ€
- éªŒè¯æƒé™é…ç½®
- æŸ¥çœ‹é”™è¯¯æ—¥å¿—

### 3. æ€§èƒ½é—®é¢˜

#### å†…å­˜æ³„æ¼
- ä½¿ç”¨valgrindæ£€æµ‹
- æ£€æŸ¥CGOå†…å­˜ç®¡ç†
- éªŒè¯deferæ¸…ç†é€»è¾‘

#### CPUå ç”¨è¿‡é«˜
- è°ƒæ•´æ•°æ®æ›´æ–°é¢‘ç‡
- ä¼˜åŒ–æ•°æ®å¤„ç†é€»è¾‘
- ä½¿ç”¨æ€§èƒ½åˆ†æå·¥å…·

## å¼€å‘æŒ‡å—

### 1. æ·»åŠ æ–°åŠŸèƒ½

#### æ‰©å±•æ•°æ®ç»“æ„
1. ä¿®æ”¹`g1_sdk.h`ä¸­çš„ç»“æ„ä½“å®šä¹‰
2. æ›´æ–°`g1_sdk.cpp`ä¸­çš„æ•°æ®å¤„ç†é€»è¾‘
3. åŒæ­¥`g1_types.go`ä¸­çš„Goç»“æ„ä½“
4. æ›´æ–°æ•°æ®è½¬æ¢å‡½æ•°

#### æ·»åŠ æ–°æ¥å£
1. åœ¨`g1_sdk.h`ä¸­å£°æ˜Cæ¥å£
2. åœ¨`g1_sdk.cpp`ä¸­å®ç°åŠŸèƒ½
3. åœ¨`g1_types.go`ä¸­æ·»åŠ Goå°è£…
4. æ›´æ–°æµ‹è¯•ç”¨ä¾‹

### 2. æ€§èƒ½ä¼˜åŒ–

#### å†…å­˜ä¼˜åŒ–
- ä½¿ç”¨å†…å­˜æ± å‡å°‘åˆ†é…
- ä¼˜åŒ–æ•°æ®ç»“æ„å¸ƒå±€
- å‡å°‘ä¸å¿…è¦çš„æ•°æ®å¤åˆ¶

#### å¹¶å‘ä¼˜åŒ–
- ä½¿ç”¨æ— é”æ•°æ®ç»“æ„
- ä¼˜åŒ–é”ç²’åº¦
- å¼‚æ­¥å¤„ç†éå…³é”®è·¯å¾„

### 3. æµ‹è¯•ç­–ç•¥

#### å•å…ƒæµ‹è¯•
- C++å±‚åŠŸèƒ½æµ‹è¯•
- Goå±‚æ¥å£æµ‹è¯•
- CGOç»‘å®šæµ‹è¯•

#### é›†æˆæµ‹è¯•
- ç«¯åˆ°ç«¯åŠŸèƒ½æµ‹è¯•
- æ€§èƒ½åŸºå‡†æµ‹è¯•
- ç¨³å®šæ€§æµ‹è¯•

#### å‹åŠ›æµ‹è¯•
- é•¿æ—¶é—´è¿è¡Œæµ‹è¯•
- é«˜é¢‘æ•°æ®æ›´æ–°æµ‹è¯•
- å¼‚å¸¸æƒ…å†µæ¢å¤æµ‹è¯•

## æ€»ç»“

æœ¬é¡¹ç›®æˆåŠŸå®ç°äº†å®‡æ ‘G1æœºå™¨äººSDKçš„å®Œæ•´é›†æˆï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š

### âœ… å·²å®ç°åŠŸèƒ½
1. **å®Œæ•´çš„C++ SDKå°è£…**: æ”¯æŒçœŸå®DDSå’Œæ¨¡æ‹Ÿæ¨¡å¼
2. **CGOæ¥å£ç»‘å®š**: Goè¯­è¨€æ— ç¼è°ƒç”¨C++ SDK
3. **BMSæ•°æ®æ”¶é›†**: 40èŠ‚ç”µæ± +12ä¸ªæ¸©åº¦ä¼ æ„Ÿå™¨å®Œæ•´ç›‘æ§
4. **å®æ—¶æ•°æ®å¤„ç†**: 10Hzæ•°æ®æ›´æ–°ï¼Œæ”¯æŒå¼‚æ­¥å›è°ƒ
5. **è‡ªåŠ¨è¿æ¥ç®¡ç†**: æ–­çº¿é‡è¿ï¼ŒçŠ¶æ€ç›‘æ§
6. **å®Œæ•´çš„é”™è¯¯å¤„ç†**: åˆ†å±‚é”™è¯¯ä¼ æ’­æœºåˆ¶
7. **ç›‘æ§æŒ‡æ ‡è½¬æ¢**: å®Œæ•´çš„PrometheusæŒ‡æ ‡æ”¯æŒ
8. **å¤šå¹³å°ç¼–è¯‘**: æ”¯æŒx86_64å’ŒARM64æ¶æ„

### ğŸ”§ æŠ€æœ¯ä¼˜åŠ¿
1. **é«˜æ€§èƒ½**: ä½å»¶è¿Ÿï¼Œä½èµ„æºå ç”¨
2. **é«˜å¯é **: è‡ªåŠ¨æ¢å¤ï¼Œå†…å­˜å®‰å…¨
3. **å¯æ‰©å±•**: æ’ä»¶åŒ–æ¶æ„ï¼Œæ”¯æŒå¤šæœºå™¨äºº
4. **æ˜“ç»´æŠ¤**: æ¸…æ™°çš„åˆ†å±‚è®¾è®¡ï¼Œå®Œæ•´çš„æ–‡æ¡£

### ğŸ“ˆ åº”ç”¨ä»·å€¼
1. **å®æ—¶ç›‘æ§**: ä¸ºG1æœºå™¨äººæä¾›å…¨é¢çš„ç”µæ± ç›‘æ§
2. **é¢„è­¦ç³»ç»Ÿ**: åŠæ—¶å‘ç°ç”µæ± å¼‚å¸¸å’Œæ½œåœ¨é£é™©
3. **æ•°æ®åˆ†æ**: ä¸ºç”µæ± æ€§èƒ½ä¼˜åŒ–æä¾›æ•°æ®æ”¯æ’‘
4. **è¿ç»´æ”¯æŒ**: ç®€åŒ–æœºå™¨äººè¿ç»´ç®¡ç†å·¥ä½œ

æœ¬é›†æˆæ–¹æ¡ˆä¸ºå®‡æ ‘G1æœºå™¨äººçš„å·¥ä¸šåŒ–åº”ç”¨æä¾›äº†åšå®çš„æŠ€æœ¯åŸºç¡€ã€‚ 